{% extends "base.html" %} {% block title %}Home - My Blog{% endblock %} {% block
content %}

<div class="posts">
  <div class="quick-search">
    <form method="GET" action="/search" class="quick-search-form">
      <input
        type="text"
        name="q"
        placeholder="Quick Search posts..."
        class="quick-search-input"
        autofocus
      />
      <button type="submit" class="quick-search-btn">üîç</button>
    </form>
  </div>
  <h2>Recent Posts</h2>

  {% if posts %} {% for post in posts %}
  <article class="post">
    <div class="post-header">
      <div>
        <h3>{{ post.title }}</h3>
        <div class="post-meta">
          <span class="author"
            >By
            <a href="/user/{{ post.username }}" class="username-link"
              >{{ post.username }}</a
            ></span
          >
          <span class="date">{{ post.created_at.strftime('%B %d, %Y') }}</span>
        </div>
      </div>

      <!-- Show edit/delete buttons only for post author -->
      <div
        class="post-actions"
        id="post-actions-{{ post.id }}"
        style="display: none"
      >
        <a href="/edit-post/{{ post.id }}" class="edit-btn">Edit</a>
        <button
          type="button"
          onclick="deletePost({{ post.id }})"
          class="delete-btn"
        >
          Delete
        </button>
      </div>
    </div>

    <div class="post-content markdown-content">
      {{ post.content|markdown | safe }}
    </div>

    <!-- Tags Section -->
    {% if post.tags %}
    <div class="post-tags">
      {% for tag in post.tags %}
      <a href="/tags/{{ tag.id }}" class="tag">{{ tag.name }}</a>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Comments Section -->
    <div class="comments-section">
      <h4>Comments ({{ post.comments|length }})</h4>

      {% if post.comments %}
      <div class="comments-list">
        {% for comment in post.comments %}
        <div class="comment">
          <div class="comment-meta">
            <strong>{{ comment.username }}</strong>
            <span class="comment-date"
              >{{ comment.created_at.strftime('%B %d, %Y at %H:%M') }}</span
            >
          </div>
          <p class="comment-content">{{ comment.content }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-comments">No comments yet. Be the first to comment!</p>
      {% endif %}

      <!-- Comment Form -->
      <div class="comment-form">
        <h5>Add a Comment</h5>
        <form class="add-comment-form" data-post-id="{{ post.id }}">
          <textarea
            class="comment-input"
            placeholder="Write your comment..."
            rows="3"
            required
          ></textarea>
          <button type="submit" class="comment-btn">Post Comment</button>
          <div class="comment-message"></div>
        </form>
      </div>
    </div>
  </article>
  {% endfor %} {% else %}
  <p>No posts yet. Be the first to write something!</p>
  {% endif %}

  <script>
        // Handle comment form submissions
        document.querySelectorAll(".add-comment-form").forEach((form) => {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const postId = form.getAttribute("data-post-id");
            const textarea = form.querySelector(".comment-input");
            const messageDiv = form.querySelector(".comment-message");
            const button = form.querySelector(".comment-btn");
            const content = textarea.value.trim();

            console.log("Posting comment to post ID:", postId);
            console.log("Comment content:", content);

            if (!content) {
              messageDiv.innerHTML = '<p class="error">Please leave a comment...</p>';
              return;
            }

            //Disable button during submission
            button.disabled = true;
            button.textContent = "Posting comment...";

            try {
              const response = await fetch(`/api/posts/${postId}/comments`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ content: content }),
              });

              console.log("Response status:", response.status);
              console.log("Response OK:", response.ok);

              const data = await response.json();
              console.log("Response data:", data);

              if (response.ok) {
                messageDiv.innerHTML = '<p class="success">Comment posted!</p>';
                textarea.value = "";
                // Reload the page to show the new comment
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              } else {
                console.error("Error posting comment:", data);
                messageDiv.innerHTML = '<p class="error">' + data.error + "</p>";
                button.disabled = false;
                button.textContent = "Post Comment";
              }
            } catch (error) {
              messageDiv.innerHTML =
                '<p class="error">Failed to post comment. Please try again.</p>';
              button.disabled = false;
              button.textContent = "Post Comment";
            }
          });
        });

    // Show edit/delete buttons only for user's own posts
    async function checkPostOwner() {
        try {
            const response = await fetch('/api/me');
            if (response.ok) {
                const data = await response.json();
                const userId = data.user.id;

                // Create an object mapping post IDs to user IDs
                const posts = {
                    {% for post in posts %}
                    {{ post.id }}: {{ post.user_id }}{{ "," if not loop.last else "" }}
                    {% endfor %}
                };

                console.log('Current user ID:', userId);
                console.log('Posts and their user IDs:', posts);

                // Show action buttons for posts belonging to current user
                for (const [postId, postUserId] of Object.entries(posts)) {
                  console.log(`Checking post ${postId}: user ${postUserId} === ${userId}?`);
                    if (postUserId === userId) {
                        const element = document.getElementById('post-actions-' + postId);
                        if (element) {
                          console.log(`Showing buttons for post ${postId}`);
                          element.style.display = 'block';
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error checking post ownership:', error);
        }
    }

    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch('/api/posts/' + postId, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                alert('Post deleted successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Failed to delete post. Please try again.');
        }
    }
        // Check post ownership on page load
        checkPostOwner();
  </script>
</div>
{% endblock %}
