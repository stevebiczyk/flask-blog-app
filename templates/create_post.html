{% extends "base.html" %} {% block title %}Create Post - My Blog{% endblock %}
{% block content %}

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"
/>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<div class="form-container">
  <h2>Create a New Post</h2>
  <form id="createPostForm">
    <div class="form-group">
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" required maxlenght="200" />
    </div>
    <div class="form-group">
      <label for="cover-image">Cover Image (Optional):</label>
      <input type="file" id="cover-image" name="cover_image" accept="image/*" />
      <small class="form-help"
        >Add a cover image to your post (optional). Max 5MB.</small
      >
      <div id="cover-preview" style="display: none; margin-top: 1rem">
        <img
          id="cover-preview-img"
          style="max-width: 100%; border-radius: 8px"
        />
      </div>
    </div>
    <div class="form-group">
      <label for="content">Content:</label>
      <textarea id="content" name="content" rows="10"></textarea>
    </div>
    <div class="form-group">
      <label for="tags">Tags (comma-separated):</label>
      <input
        type="text"
        id="tags"
        name="tags"
        placeholder="e.g. python, tutorial, beginner"
        maxlength="200"
      />
      <small class="form-help"
        >Enter tags separated by commas. Tags will be converted to
        lowercase.</small
      >
    </div>
    <button type="submit" class="submit-btn">Create Post</button>
  </form>
  <div id="message"></div>
</div>

<script>
  // Initialize SimpleMDE Markdown Editor
  var simplemde = new SimpleMDE({
    element: document.getElementById("content"),
    spellChecker: false,
    placeholder: "Write your post content here... (Markdown supported)",
    toolbar: [
      "bold",
      "italic",
      "heading",
      "|",
      "quote",
      "unordered-list",
      "ordered-list",
      "|",
      "link",
      "image",
      "|",
      "preview",
      "side-by-side",
      "fullscreen",
      "|",
      "guide",
    ],
  });

  // Allowed file types for cover image
  const allowedTypes = [
    "image/jpeg",
    "image/jpg",
    "image/png",
    "image/gif",
    "image/webp",
  ];

  // Preview cover image with validation
  document
    .getElementById("cover-image")
    .addEventListener("change", function () {
      const coverMessage = document.getElementById("cover-message");
      coverMessage.innerHTML = ""; // Clear previous messages

      if (this.files && this.files[0]) {
        const file = this.files[0];

        // Validate file type
        if (!allowedTypes.includes(file.type)) {
          coverMessage.innerHTML =
            '<p class="error" style="color: #f44336; margin-top: 0.5rem;">Invalid file type. Please upload PNG, JPG, GIF, or WebP.</p>';
          this.value = "";
          document.getElementById("cover-preview").style.display = "none";
          return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert("File size exceeds 5MB limit.");
          this.value = "";
          previewDiv.style.display = "none";
          return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("cover-preview").style.display = "block";
          document.getElementById("cover-preview-img").src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        // Hide preview if no file selected
        document.getElementById("cover-preview").style.display = "none";
      }
    });

  // Handle form submission with file upload support
  document
    .getElementById("createPostForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const content = simplemde.value();
      // const content = document.getElementById("content").value.trim();
      const tagsInput = document.getElementById("tags").value.trim();
      const coverImage = document.getElementById("cover-image").files[0];
      const messageDiv = document.getElementById("message");
      const button = e.target.querySelector(".submit-btn");
      //const button = this .querySelector('button[type="submit"]');

      // Clear previous messages
      messageDiv.innerHTML = "";

      // Validate title
      if (!title) {
        messageDiv.innerHTML =
          '<p class="error" style="color: #f44336;">✗ Title is required.</p>';
        document.getElementById("title").focus();
        return;
      }

      // Validate content
      if (!content) {
        messageDiv.innerHTML =
          '<p class="error" style="color: #f44336;">✗ Content is required.</p>';
        simplemde.codemirror.focus();
        return;
      }

      // Parse tags from comma-separated string
      const tags = tagsInput
        ? tagsInput
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t)
        : [];

      // Disable button during submission
      button.disabled = true;
      button.textContent = "Creating post...";

      try {
        const formData = new FormData();
        formData.append("title", title);
        formData.append("content", content);
        formData.append("tags", tagsInput);
        if (coverImage) {
          formData.append("cover_image", coverImage);
        }

        const response = await fetch("/api/posts", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          messageDiv.innerHTML =
            '<p class="success" style="color: #4CAF50;">✓ Post created successfully! Redirecting...</p>';
          setTimeout(function () {
            window.location.href = "/";
          }, 1000);
        } else {
          messageDiv.innerHTML =
            '<p class="error" style="color: #f44336;">✗ ' +
            (data.error || "Failed to create post") +
            "</p>";
          button.disabled = false;
          button.textContent = "Create Post";
        }
      } catch (error) {
        console.error("Error creating post:", error);
        messageDiv.innerHTML =
          '<p class="error" style="color: #f44336;">✗ An error occurred. Please try again.</p>';
        button.disabled = false;
        button.textContent = "Create Post";
      }
    });
</script>
{% endblock %}
