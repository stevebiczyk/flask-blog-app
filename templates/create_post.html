{% extends "base.html" %} {% block title %}Create Post - My Blog{% endblock %}
{% block content %}

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css"
/>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<div class="form-container">
  <h2>Create a New Post</h2>
  <form id="createPostForm">
    <div class="form-group">
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" required maxlenght="200" />
    </div>
    <div class="form-group">
      <label for="content">Content:</label>
      <textarea id="content" name="content" rows="10"></textarea>
    </div>
    <div class="form-group">
      <label for="tags">Tags (comma-separated):</label>
      <input
        type="text"
        id="tags"
        name="tags"
        placeholder="e.g. python, tutorial, beginner"
        maxlength="200"
      />
      <small class="form-help"
        >Enter tags separated by commas. Tags will be converted to
        lowercase.</small
      >
    </div>
    <button type="submit" class="submit-btn">Create Post</button>
  </form>
  <div id="message"></div>
</div>

<script>
  // Initialize SimpleMDE Markdown Editor
  var simplemde = new SimpleMDE({
    element: document.getElementById("content"),
    spellChecker: false,
    placeholder: "Write your post content here... (Markdown supported)",
    toolbar: [
      "bold",
      "italic",
      "heading",
      "|",
      "quote",
      "unordered-list",
      "ordered-list",
      "|",
      "link",
      "image",
      "|",
      "preview",
      "side-by-side",
      "fullscreen",
      "|",
      "guide",
    ],
  });
  document
    .getElementById("createPostForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const content = simplemde.value();
      // const content = document.getElementById("content").value.trim();
      const tagsInput = document.getElementById("tags").value.trim();
      const messageDiv = document.getElementById("message");
      const button = e.target.querySelector(".submit-btn");
      //const button = this .querySelector('button[type="submit"]');

      if (!title || !content) {
        messageDiv.innerHTML =
          '<p class="error">Both title and content are required.</p>';
        messageDiv.style.color = "red";
        return;
      }

      // Parse tags from comma-separated string
      const tags = tagsInput
        ? tagsInput
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t)
        : [];

      // Disable button during submission
      button.disabled = true;
      button.textContent = "Creating post...";

      try {
        const response = await fetch("/api/posts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title: title, content: content, tags: tags }),
        });

        const data = await response.json();

        if (response.ok) {
          messageDiv.innerHTML =
            '<p class="success">Post created successfully!</p>';
          messageDiv.style.color = "green";
          setTimeout(function () {
            window.location.href = "/";
          }, 1000);
        } else {
          messageDiv.innerHTML = '<p class="error">' + data.error + "</p>";
          button.disabled = false;
          button.textContent = "Create Post";
        }
      } catch (error) {
        messageDiv.innerHTML =
          '<p class="error">An error occurred. Please try again.</p>';
        button.disabled = false;
        button.textContent = "Create Post";
      }
    });
</script>
{% endblock %}
