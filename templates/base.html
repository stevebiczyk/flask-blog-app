<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="A personal blog built with Flask and PostgreSQL"
    />
    <meta name="keywords" content="blog, flask, python, posts" />
    <title>{% block title %}My Blog{% endblock title %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <nav>
      <div class="container">
        <div class="nav-header">
          <h1><a href="/">My Blog</a></h1>

          <div class="nav-controls">
            <!-- Dark Mode Toggle -->
            <button
              id="theme-toggle"
              class="theme-toggle"
              aria-label="Toggle dark mode"
            >
              <span class="theme-icon">üåô</span>
            </button>

            <!-- Mobile Menu Toggle -->
            <button
              id="mobile-menu-toggle"
              class="mobile-menu-toggle"
              aria-label="Toggle menu"
            >
              <span class="hamburger"></span>
              <span class="hamburger"></span>
              <span class="hamburger"></span>
            </button>
          </div>
        </div>

        <div class="nav-menu" id="nav-menu">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/tags">Tags</a></li>
            <li><a href="/search">Search</a></li>
            <li><a href="/settings">‚öôÔ∏è Settings</a></li>
            <li id="nav-register"><a href="/register">Register</a></li>
            <li id="nav-login"><a href="/login">Login</a></li>
            <li id="nav-user" style="display: none">
              <a href="/create-post" class="create-post-link">Create Post</a>
              <a href="/liked-posts" class="liked-link">Liked Posts</a>
              <a href="#" id="nav-profile-link" class="profile-link"
                >My Profile</a
              >
              <button onclick="logout()" class="logout-btn">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <script>
      // Get theme from localStorage or default to light
      function getTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          return savedTheme;
        }

        // Check user's system preference
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          return "dark";
        }

        return "light";
      }

      // Apply theme to document
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);

        // Update toggle icon
        const themeIcon = document.querySelector(".theme-icon");
        if (themeIcon) {
          themeIcon.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        // Save to localStorage
        localStorage.setItem("theme", theme);
      }

      // Toggle theme on button click
      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        applyTheme(newTheme);
      }

      // Apply theme on page load
      applyTheme(getTheme());

      // Add event listener to theme toggle button
      document.addEventListener("DOMContentLoaded", () => {
        const themeToggle = document.getElementById("theme-toggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", toggleTheme);
        }
      });

      // Listen for system theme changes
      if (window.matchMedia) {
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            const newTheme = e.matches ? "dark" : "light";
            applyTheme(newTheme);
          });
      }

      //Check if user is logged in when page loads
      async function checkLoginStatus() {
        try {
          const response = await fetch("/api/me");
          if (response.ok) {
            const data = await response.json();
            // User is logged in
            document.getElementById("nav-login").style.display = "none";
            document.getElementById("nav-register").style.display = "none";
            document.getElementById("nav-user").style.display = "inline";
            // document.getElementById("nav-username").textContent =
            // "Welcome," + data.user.username;

            // Set profile link
            const profileLink = document.getElementById("nav-profile-link");
            profileLink.href = "/user/" + data.user.username;
          }
        } catch (error) {
          console.error("Error checking login status:", error);
        }
      }

      async function logout() {
        try {
          await fetch("/api/logout", {
            method: "POST",
          });
          // Redirect to home page after logout
          window.location.href = "/";
        } catch (error) {
          alert("Logout failed. Please try again.");
          console.error("Error during logout:", error);
        }
      }

      // Check login status on page load
      checkLoginStatus();

      // ============================================================================
      // MOBILE MENU FUNCTIONALITY
      // ============================================================================
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
        const navMenu = document.getElementById("nav-menu");

        if (mobileMenuToggle) {
          mobileMenuToggle.addEventListener("click", function () {
            // Toggle active classes
            mobileMenuToggle.classList.toggle("active");
            navMenu.classList.toggle("active");
          });

          // Close mobile menu when a link is clicked
          const navLinks = navMenu.querySelectorAll("a");
          navLinks.forEach((link) => {
            link.addEventListener("click", function () {
              mobileMenuToggle.classList.remove("active");
              navMenu.classList.remove("active");
            });
          });
        }
      });
    </script>
    <main class="container">{% block content %}{% endblock %}</main>
    <footer>
      <div class="container">
        <p>&copy; 2024 My Blog - Learning PostgreSQL with Flask</p>
      </div>
    </footer>
  </body>
</html>
